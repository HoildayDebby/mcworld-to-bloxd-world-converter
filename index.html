<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Minecraft → Bloxd Converter</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body {
      font-family: system-ui, Arial;
      max-width: 820px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .drop {
      border: 3px dashed #999;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      transition: 0.2s;
      cursor: pointer;
    }

    .drop.dragover {
      border-color: #4caf50;
      background: #eaffea;
    }

    button {
      padding: .6rem 1rem;
      margin: .3rem;
      cursor: pointer;
    }

    pre {
      background:#f6f6f6;
      padding: .75rem;
      border-radius:6px;
      overflow:auto
    }
  </style>
</head>

<body>
  <h1>Minecraft World → Bloxd Schematic Converter</h1>

  <p>
    Drop a <b>.mcworld</b>, <b>.schem</b>, <b>.schematic</b>, or <b>.litematic</b> file below.<br>
    The tool will unzip, detect schematics, and convert them to <code>.bloxdschem</code>.
  </p>

  <!-- DROP AREA -->
  <div id="drop" class="drop">
    <p>Drop your file here<br>or click to pick</p>
    <input id="file" type="file" hidden />
    <div id="status"></div>
    <div id="actions"></div>
  </div>

  <h2>Helpful Links</h2>
  <ul>
    <li><a href="https://cubical.xyz" target="_blank">Cubical — export .schem</a></li>
    <li><a href="https://chunker.app" target="_blank">Chunker — world converter</a></li>
  </ul>

  <!-- Required external libs -->
  <script src="vendor/jszip.min.js"></script>
  <script src="vendor/m2b.js"></script>

  <script>
    const drop = document.getElementById("drop");
    const fileInput = document.getElementById("file");
    const status = document.getElementById("status");
    const actions = document.getElementById("actions");

    function setStatus(t) { status.textContent = t; }
    function clearActions() { actions.innerHTML = ""; }

    // Drag-drop events
    drop.addEventListener("click", () => fileInput.click());

    drop.addEventListener("dragover", e => {
      e.preventDefault();
      drop.classList.add("dragover");
    });

    drop.addEventListener("dragleave", () => {
      drop.classList.remove("dragover");
    });

    drop.addEventListener("drop", e => {
      e.preventDefault();
      drop.classList.remove("dragover");

      const f = e.dataTransfer.files[0];
      if (!f) return;

      fileInput.files = e.dataTransfer.files;
      fileInput.dispatchEvent(new Event("change"));
    });

    // Input change handler
    fileInput.addEventListener("change", async (ev) => {
      clearActions();
      const f = ev.target.files[0];
      if (!f) return;

      const name = f.name.toLowerCase();
      setStatus("Processing: " + f.name);

      // Direct schematic → bloxdschem
      if (name.endsWith(".schem") || name.endsWith(".schematic") || name.endsWith(".litematic")) {
        return convertWithM2B(f);
      }

      // MCWORLD unzip
      if (name.endsWith(".mcworld") || name.endsWith(".zip")) {
        return handleMcworld(f);
      }

      setStatus("Unsupported file type.");
    });

    // Conversion using M2B
    async function convertWithM2B(blob) {
      try {
        setStatus("Converting → .bloxdschem ...");
        if (!window.m2b || !m2b.convertFile) {
          throw "M2B converter missing. You must put vendor/m2b.js in your repo.";
        }
        const result = await m2b.convertFile(blob);
        downloadBlob(result.blob, result.filename);
        setStatus("Done! File downloaded.");
      } catch (e) {
        setStatus("Conversion failed: " + e);
      }
    }

    // Handle .mcworld (ZIP) files
    async function handleMcworld(f) {
      try {
        setStatus("Unzipping .mcworld...");
        const buf = await f.arrayBuffer();
        const zip = await JSZip.loadAsync(buf);

        const found = [];
        zip.forEach((path, entry) => {
          const l = path.toLowerCase();
          if (l.endsWith(".schem") || l.endsWith(".schematic") || l.endsWith(".litematic") || l.endsWith(".bloxdschem")) {
            found.push({ path, entry });
          }
        });

        if (found.length === 0) {
          setStatus("No schematic inside this world.");
          actions.innerHTML = `
            <button onclick="window.open('https://cubical.xyz')">Open Cubical</button>
            <button onclick="window.open('https://chunker.app')">Open Chunker</button>
          `;
          return;
        }

        // Use first schematic found
        const first = found[0];
        setStatus("Found schematic: " + first.path);

        const blob = await first.entry.async("blob");

        if (first.path.toLowerCase().endsWith(".bloxdschem")) {
          downloadBlob(blob, first.path.split("/").pop());
          setStatus("Downloaded embedded .bloxdschem");
        } else {
          convertWithM2B(blob);
        }

      } catch (e) {
        setStatus("Error reading .mcworld: " + e);
      }
    }

    // Download helper
    function downloadBlob(blob, filename = "output.bloxdschem") {
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }
  </script>

</body>
</html>
