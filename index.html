<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Minecraft → Bloxd Converter</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:system-ui,Arial;max-width:820px;margin:2rem auto;padding:0 1rem;}
.drop{border:3px dashed #999;border-radius:12px;padding:40px;text-align:center;transition:.2s;cursor:pointer;}
.drop.dragover{border-color:#4caf50;background:#eaffea;}
button{padding:.6rem 1rem;margin:.3rem;cursor:pointer;}
pre{background:#f6f6f6;padding:.75rem;border-radius:6px;overflow:auto;}
</style>
</head>
<body>
<h1>Minecraft World → Bloxd Schematic Converter</h1>
<p>Drop a <b>.mcworld</b>, <b>.schem</b>, <b>.schematic</b>, or <b>.litematic</b> file below.<br>
The tool will convert it to <code>.bloxdschem</code> for Bloxd.io.</p>

<div id="drop" class="drop">
<p>Drop your file here<br>or click to pick</p>
<input id="file" type="file" hidden />
<div id="status"></div>
<div id="actions"></div>
</div>

<script src="vendor/jszip.min.js"></script>
<script src="vendor/m2b.js"></script>
<script>
const drop=document.getElementById("drop");
const fileInput=document.getElementById("file");
const status=document.getElementById("status");
const actions=document.getElementById("actions");

function setStatus(t){status.textContent=t;}
function clearActions(){actions.innerHTML="";}

drop.addEventListener("click",()=>fileInput.click());
drop.addEventListener("dragover",e=>{e.preventDefault();drop.classList.add("dragover");});
drop.addEventListener("dragleave",()=>drop.classList.remove("dragover"));
drop.addEventListener("drop",e=>{e.preventDefault();drop.classList.remove("dragover");const f=e.dataTransfer.files[0];if(!f)return;fileInput.files=e.dataTransfer.files;fileInput.dispatchEvent(new Event("change"));});

fileInput.addEventListener("change",async(ev)=>{
  clearActions();
  const f=ev.target.files[0];
  if(!f)return;
  const name=f.name.toLowerCase();
  setStatus("Processing: "+f.name);

  if(name.endsWith(".schem")||name.endsWith(".schematic")||name.endsWith(".litematic")){
    convertWithM2B(f);
  } else if(name.endsWith(".mcworld")||name.endsWith(".zip")){
    handleMcworld(f);
  } else {
    setStatus("Unsupported file type.");
  }
});

async function convertWithM2B(blob){
  try{
    setStatus("Converting → .bloxdschem ...");
    if(!window.m2b||!m2b.convertFile) throw "M2B converter missing";
    const result=await m2b.convertFile(blob);
    downloadBlob(result.blob,result.filename);
    setStatus("Done! File downloaded.");
  }catch(e){setStatus("Conversion failed: "+e);}
}

async function handleMcworld(f){
  try{
    setStatus("Unzipping .mcworld...");
    const buf=await f.arrayBuffer();
    const zip=await JSZip.loadAsync(buf);

    const found=[];
    let isFullWorld=false;

    zip.forEach((path,entry)=>{
      const l=path.toLowerCase();
      if(l.endsWith(".schem")||l.endsWith(".schematic")||l.endsWith(".litematic")) found.push({path,entry});
      if(l.endsWith("level.dat")) isFullWorld=true;
    });

    if(found.length>0){
      // Convert first schematic by default
      const first=found[0];
      setStatus("Found schematic: "+first.path);
      const blob=await first.entry.async("blob");
      convertWithM2B(blob);
    }

    if(isFullWorld){
      const btnSingle=document.createElement("button");
      btnSingle.textContent="Convert Full World → Single Schematic";
      btnSingle.onclick=()=>convertFullWorldSingle(zip);
      actions.appendChild(btnSingle);

      const btnMulti=document.createElement("button");
      btnMulti.textContent="Convert Full World → Multiple Schematics (ZIP)";
      btnMulti.onclick=()=>convertFullWorldMulti(zip);
      actions.appendChild(btnMulti);

      setStatus("Full world detected. Choose conversion method below.");
    }

    if(found.length===0&&!isFullWorld){
      setStatus("No schematics found inside this world.");
    }

  }catch(e){setStatus("Error reading .mcworld: "+e);}
}

// Placeholder: single schematic combining all blocks
async function convertFullWorldSingle(zip){
  setStatus("Converting full world → single schematic...");
  try{
    // For demo: just collects all schematics inside, combine
    const allBlobs=[];
    zip.forEach((path,entry)=>{
      const l=path.toLowerCase();
      if(l.endsWith(".schem")||l.endsWith(".schematic")||l.endsWith(".litematic")){
        allBlobs.push(entry.async("blob"));
      }
    });
    const blobs=await Promise.all(allBlobs);
    if(blobs.length===0){setStatus("No schematics inside for single conversion."); return;}
    
    const zipOutput=new JSZip();
    for(let i=0;i<blobs.length;i++){
      const result=await m2b.convertFile(blobs[i]);
      zipOutput.file(result.filename,result.blob);
    }
    const combined=await zipOutput.generateAsync({type:"blob"});
    downloadBlob(combined,"full_world_combined.bloxdschem.zip");
    setStatus("Full world single schematic downloaded (ZIP containing all converted).");
  }catch(e){setStatus("Conversion failed: "+e);}
}

// Placeholder: multiple schematics per region
async function convertFullWorldMulti(zip){
  setStatus("Converting full world → multiple schematics...");
  try{
    const allBlobs=[];
    zip.forEach((path,entry)=>{
      const l=path.toLowerCase();
      if(l.endsWith(".schem")||l.endsWith(".schematic")||l.endsWith(".litematic")){
        allBlobs.push(entry.async("blob"));
      }
    });
    const blobs=await Promise.all(allBlobs);
    if(blobs.length===0){setStatus("No schematics inside for multi conversion."); return;}

    const zipOutput=new JSZip();
    for(let i=0;i<blobs.length;i++){
      const result=await m2b.convertFile(blobs[i]);
      zipOutput.file(result.filename,result.blob);
    }

    const content=await zipOutput.generateAsync({type:"blob"});
    downloadBlob(content,"full_world_schematics.zip");
    setStatus("Full world multiple schematics downloaded as ZIP.");
  }catch(e){setStatus("Full world multi conversion failed: "+e);}
}

function downloadBlob(blob,filename="output.bloxdschem"){
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download=filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
