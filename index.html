<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Minecraft → Bloxd Converter</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:system-ui,Arial;max-width:820px;margin:2rem auto;padding:0 1rem;}
.drop{border:3px dashed #999;border-radius:12px;padding:40px;text-align:center;transition:.2s;cursor:pointer;}
.drop.dragover{border-color:#4caf50;background:#eaffea;}
button{padding:.6rem 1rem;margin:.3rem;cursor:pointer;}
pre{background:#f6f6f6;padding:.75rem;border-radius:6px;overflow:auto;}
</style>
</head>
<body>
<h1>Minecraft World → Bloxd Schematic Converter</h1>
<p>Drop a <b>.mcworld</b>, <b>.schem</b>, <b>.schematic</b>, or <b>.litematic</b> file below.<br>
The tool will convert Minecraft world blocks or schematics into <code>.bloxdschem</code> for Bloxd.io.</p>

<div id="drop" class="drop">
<p>Drop your file here<br>or click to pick</p>
<input id="file" type="file" hidden />
<div id="status"></div>
<div id="actions"></div>
</div>

<script src="vendor/jszip.min.js"></script>
<script src="vendor/m2b.js"></script>
<script src="vendor/nbt.js"></script> <!-- JS NBT parser library -->
<script>
const drop = document.getElementById("drop");
const fileInput = document.getElementById("file");
const status = document.getElementById("status");
const actions = document.getElementById("actions");

function setStatus(t){status.textContent=t;}
function clearActions(){actions.innerHTML="";}

// Drag & Drop
drop.addEventListener("click",()=>fileInput.click());
drop.addEventListener("dragover",e=>{e.preventDefault();drop.classList.add("dragover");});
drop.addEventListener("dragleave",()=>drop.classList.remove("dragover"));
drop.addEventListener("drop",e=>{
  e.preventDefault(); drop.classList.remove("dragover");
  const f=e.dataTransfer.files[0];
  if(!f) return;
  fileInput.files = e.dataTransfer.files;
  fileInput.dispatchEvent(new Event("change"));
});

fileInput.addEventListener("change", async (ev)=>{
  clearActions();
  const f = ev.target.files[0];
  if(!f) return;
  const name = f.name.toLowerCase();
  setStatus("Processing: "+f.name);

  if(name.endsWith(".schem")||name.endsWith(".schematic")||name.endsWith(".litematic")){
    convertWithM2B(f);
  } else if(name.endsWith(".mcworld")){
    convertMcworldToSchematic(f);
  } else {
    setStatus("Unsupported file type.");
  }
});

async function convertWithM2B(blob){
  try{
    setStatus("Converting → .bloxdschem ...");
    const result = await m2b.convertFile(blob);
    downloadBlob(result.blob,result.filename);
    setStatus("Done! File downloaded.");
  }catch(e){setStatus("Conversion failed: "+e);}
}

// NEW: Convert .mcworld to schematic
async function convertMcworldToSchematic(f){
  setStatus("Reading .mcworld...");
  const buf = await f.arrayBuffer();
  const zip = await JSZip.loadAsync(buf);

  // Ignore non-build files
  const regionFiles = Object.keys(zip.files).filter(p=>p.startsWith("region/") && p.endsWith(".mca"));
  if(regionFiles.length===0){
    setStatus("No region files found. Cannot convert.");
    return;
  }

  setStatus(`Found ${regionFiles.length} region files. Parsing blocks...`);

  // Parse blocks (pseudo code, needs NBT parsing)
  let tempSchematic = {width:0, height:0, length:0, blocks:[], palette:{}};

  for(let rFile of regionFiles){
    const data = await zip.files[rFile].async("arraybuffer");
    const chunks = parseMCAtoChunks(data); // parseMCAtoChunks = your NBT parser logic
    // For each chunk, extract blocks and add to tempSchematic
    // ...
  }

  setStatus("Building temporary schematic...");

  // Convert tempSchematic to Bloxd.io using M2B
  try{
    const result = await m2b.convertSchematicObject(tempSchematic); // hypothetical function
    downloadBlob(result.blob,result.filename);
    setStatus("Done! Bloxd.io schematic ready.");
  }catch(e){
    setStatus("Conversion failed: "+e);
  }
}

function downloadBlob(blob, filename="output.bloxdschem"){
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
</script>
</body>
</html>
